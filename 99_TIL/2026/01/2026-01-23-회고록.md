# 2026-01-23 회고록: LLEAP 로그 형식 완벽 통일

> 아침부터 저녁까지 집중 작업. 하루종일 코딩하는 거 진짜 어렵다...

---

## 작업 규모

- **커밋 수:** 31개
- **수정 파일:** 6개
  - ParameterTranslations.cs
  - SimulatorMonitor.cs
  - SimBridgeMessage.cs
  - WcfEventCapture.cs
  - EventTranslations.cs
  - MainForm.cs

---

## 해결한 Critical 버그

### 1. SimMonitor 완전 동작 불능 버그

**증상:** `Type=Unknown, Params=0` 출력, 모든 파라미터 캡처 실패

**원인:** LungSound 딕셔너리에 `"CUSTOM"`과 `"Custom"` 중복 추가
- `StringComparer.OrdinalIgnoreCase`로 대소문자 무시 설정
- 대소문자만 다른 키 추가 시 → 중복 키 예외 → static 초기화 실패

**해결:** 중복 키 제거

**교훈:** 대소문자 무시 딕셔너리에 대소문자만 다른 키 추가 금지!

### 2. 볼륨 파라미터 필터링 버그

**증상:** 심음 볼륨 0%, 10%, 40%, 70%가 SIMPREC에 안 나옴

**원인:** NoiseValues에 "10", "40", "70" 포함 + `_Percent` enum 번역

**해결:** Volume_Percent 우선 체크, enum 번역 제외

---

## LLEAP 형식 통일 (핵심 성과)

| 항목 | Before | After (LLEAP 일치) |
|------|--------|-------------------|
| 심음 볼륨 | `Heart sound volume: Normal` | `Heart sound volume = 0 %` |
| 기흉 | `Airway.PneumothoraxLeftVer2: TENSION` | `왼쪽 기흉 = 긴장` |
| 폐 저항 | `왼쪽 폐 저항: 100` | `왼쪽 폐 저항 = 100 %` |
| 맥박 | `Pulses.RightArm.Limited: WEAK` | `오른쪽 팔 맥박 = 약함` |

---

## 맥박 중복 문제 발견 과정

### 문제 발견

1. 처음: `PulsesCentral` → "중심 맥박" vs `Pulses.Central.Limited` → "맥박, 중앙"
2. IgnoredParameters에 `PulsesCentral` 추가 → 아직 중복
3. 원인 발견: `GetDisplayName()`에서 `.` 제거 후 재검색
   - `Pulses.LeftArm` → `PulsesLeftArm`으로 매칭됨
4. 해결: `Pulses.LeftArm` 형식도 IgnoredParameters에 추가 (총 20개)

### 3가지 파라미터 형식

```
1. PulsesLeftArm          → "좌측 팔 맥박"  (무시)
2. Pulses.LeftArm         → "좌측 팔 맥박"  (무시, 정규화 매칭)
3. Pulses.LeftArm.Limited → "왼쪽 팔 맥박" (사용, LLEAP 일치)
```

---

## 기술적 발견

### 1. GetDisplayName() 정규화 로직 주의

```csharp
string normalizedName = parameterName.Replace(".", "");
if (DisplayNames.TryGetValue(normalizedName, out displayName))
    return displayName;  // Pulses.LeftArm → PulsesLeftArm으로 매칭!
```

### 2. 듀얼 파이프라인 인지 필수

- SimMonitor UI 출력: `SimBridgeMessage.GetFormattedParameters()`
- SIMPREC WebSocket 전송: `SimulatorMonitor.OnStateChanged()`
- **둘 다 수정해야 함!**

### 3. IsSignificantParameter() 역할

- SIMPREC에 전송할 파라미터 필터링
- 여기 없으면 SIMPREC에 안 나감

---

## 커밋 하이라이트

```
bdf684a fix: LungSound 딕셔너리 중복 키 제거 (CUSTOM/Custom)
3b2b89f fix: 볼륨 파라미터 LLEAP 형식 통일
039c2e5 fix: 볼륨 SIMPREC 전송 및 SimMonitor 형식 수정
120a2c0 feat: 기흉/폐 저항 파라미터 LLEAP 형식 통일
e7322c4 feat: 맥박 파라미터 LLEAP 형식 통일 및 SIMPREC 전송 추가
c612244 fix: 맥박 파라미터 중복 제거 (LLEAP 형식 통일)
659b9e5 fix: 맥박 Pulses.* 형식 추가 중복 제거
```

---

## 배운 점

1. **git bisect 활용** - 버그 원인 커밋 추적에 효과적
2. **대소문자 무시 딕셔너리 함정** - OrdinalIgnoreCase 사용 시 중복 키 주의
3. **정규화 매칭의 부작용** - 편의 기능이 예상치 못한 중복 유발 가능
4. **듀얼 파이프라인 인지** - UI 출력과 외부 전송 코드 경로가 다름

---

## 성과

### LLEAP ↔ SimMonitor ↔ SIMPREC 로그 100% 일치 달성

- 사용자가 LLEAP 디브리핑 화면과 동일한 형식으로 로그 확인 가능
- 한국어 번역 품질 대폭 향상 (LLEAP 원본 표현 그대로 사용)

---

## 개인 감상

오늘은 아침부터 저녁까지 정말 빡세게 코딩했다. 31개 커밋이라니...

특히 `CUSTOM`/`Custom` 중복 키 버그는 진짜 충격이었다. 대소문자 무시 딕셔너리에 대소문자만 다른 키를 넣으면 static 초기화가 통째로 실패한다는 걸 몸으로 배웠다. 컴파일 에러도 안 나고, 런타임에 조용히 죽어버려서 찾기가 정말 힘들다.

맥박 중복 문제도 골치 아팠다. `PulsesLeftArm`, `Pulses.LeftArm`, `Pulses.LeftArm.Limited` 세 가지 형식이 있는 줄 누가 알았겠나.

그래도 결국 **로그 100% 일치**를 달성했다. 이 성취감은 진짜 뿌듯하다.

내일은 좀 쉬고 싶다...
