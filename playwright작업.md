# Gemini 로컬 Playwright 테스트 가이드

이 문서는 로컬 환경에서 Playwright 테스트를 설정하고 실행하는 방법에 대한 핵심 정보를 요약합니다.

## 1. 환경 설정

1.  **`.env.test` 파일 생성:**
    *   프로젝트의 루트 디렉터리에서 `.env.test.sample` 파일을 복사하여 `.env.test`라는 이름의 새 파일을 만듭니다.

2.  **환경 변수 입력:**
    *   생성된 `.env.test` 파일을 열고, 실제 테스트 환경에 맞는 정보(서버 주소, ID, 비밀번호 등)를 각 변수에 맞게 입력합니다.

## 2. 의존성 설치

*   프로젝트에 필요한 라이브러리들을 설치하기 위해 터미널에서 아래 명령어를 실행합니다.

    ```bash
    # yarn을 사용하는 경우
    yarn
    ```

## 3. 테스트 실행

*   터미널에서 아래 명령어를 사용하여 테스트를 실행할 수 있습니다.

*   **전체 테스트 실행 (순차적):**
    ```bash
    yarn test
    ```

*   **UI 모드로 실행 (디버깅에 유용):**
    *   테스트 실행 과정을 시각적으로 확인하며 디버깅할 수 있습니다.
    ```bash
    npx playwright test --ui
    ```

*   **특정 파일 또는 폴더만 테스트:**
    *   `--target` 인자를 사용합니다. `yarn test` 뒤에 `--`를 붙여야 인수가 제대로 전달됩니다.
    ```bash
    yarn test -- --target tests/step1/login.spec.ts

    corepack yarn test -- --target tests/step1/login.spec.ts
    corepack yarn test -- --target tests/step2/question.spec.ts
    corepack yarn test -- --target tests/step3/setting.spec.ts
    corepack yarn test -- --target tests/step4/exam.spec.ts
    ```

*   **이름가 일치하는 테스트만 실행:**
    *   `-g` (grep) 인자를 사용합니다.
    ```bash
    yarn test -- --g "로그인 성공"
    ```

---

## 진행된 작업 요약 (2025-09-30)

이 섹션은 Gemini와 함께 진행한 테스트 작성 과정을 요약합니다.

### 1. `login.spec.ts` 직접 만들어보기

- **목표:** Playwright 테스트 작성 및 단일 파일 실행 방법 학습.
- **과정:**
    1.  기존 `tests/step1/login.spec.ts` 파일을 `login.spec.ts.bak`으로 백업.
    2.  로그인 페이지가 정상적으로 표시되는지와 로그인이 성공하는 두 가지 시나리오를 포함한 새로운 `login.spec.ts` 파일을 작성.
    3.  `yarn test -- --target tests/step1/login.spec.ts` 명령어를 사용하여 해당 파일만 테스트하고 성공적으로 통과함을 확인.

### 2. `student.spec.ts` 기능 테스트 작성하기

- **목표:** '학생 추가' 기능에 대한 새로운 E2E 테스트 작성.
- **과정:**
    1.  **요구사항 분석:** '로그인 -> 학생 계정 탭 이동 -> 학생 추가 버튼 클릭 -> 정보 입력 -> 저장' 시나리오를 확인함.
    2.  **`data-test` 속성 수집:** 시나리오에 필요한 각 UI 요소(버튼, 입력창, 결과 테이블 등)의 `data-test` 속성을 질문과 답변을 통해 수집.
    3.  **테스트 전략 수립:** `Date.now()`를 사용하여 고유한 학생 데이터를 생성하고, 작업 후 목록에 해당 데이터가 보이는지 확인하는 방식으로 검증 전략을 정함.
    4.  **코드 생성 및 수정:** `tests/step3/student.spec.ts` 파일을 생성하고, 사용자의 추가 요청에 따라 전화번호/이메일 필드도 채우도록 수정.

### 3. `student.spec.ts` 리팩토링 및 기능 확장

- **목표:** 테스트 코드의 구조를 개선하고, '학생 관리' 기능에 대한 커버리지를 높입니다.
- **과정:**
    1.  **테스트 구조 리팩토링:**
        - `test.describe`와 `beforeEach` 훅을 사용하여, 테스트의 성격에 따라 코드를 그룹화하는 방법을 논의하고 적용했습니다. (`기능 테스트` vs `유효성 검사`)
    2.  **'정보 수정' 테스트 추가:**
        - 학생 정보 수정 기능을 테스트하고, 검증 로직의 오류를 Playwright UI 모드를 통해 함께 디버깅하며 해결했습니다.
    3.  **'검색' 테스트 추가:**
        - '이름', '학번', '학년'으로 검색하는 기능을 테스트했습니다.
        - '학년' 검색처럼 여러 결과가 나오는 경우, 반복문을 통해 모든 결과를 검증하는 방법을 적용했습니다.
    4.  **'유효성 검사' 테스트 추가:**
        - 필수 항목을 비워둔 채로 폼을 제출하는 '예외 상황'을 테스트했습니다.
        - 여러 개의 동일한 오류 메시지로 인해 발생하는 `strict mode` 위반 오류를 경험하고, `.first()`를 사용한 해결 방법을 파악했습니다. (실제 코드 수정은 보류)
    5.  **Flaky 테스트 논의:**
        - E2E 테스트가 가끔씩 실패하는 'Flaky' 현상의 원인(주로 타이밍 문제)과 일반적인 해결 방향에 대해 논의했습니다.

### 4. '문제 분류' 기능 테스트 (`category.spec.ts`)

- **목표:** '설정' 메뉴의 부수 작업인 '문제 분류' 관리 기능에 대한 테스트를 작성합니다.
- **과정:**
    1.  **사전 조사:** '문제 분류'와 '학과' 데이터가 Jenkins 빌드 시 생성되는 이유를 파악하기 위해 `선임ver.txt` 파이프라인 스크립트를 분석했습니다.
        - 분석 결과, Playwright가 아닌 JMeter 테스트의 `generate_data.sh` 스크립트가 DB 초기 데이터를 생성하고 있음을 확인했습니다.
    2.  **CRUD 테스트 작성:**
        - `tests/step4/category.spec.ts` 파일을 새로 생성했습니다.
        - '문제 분류'를 추가, 수정, 삭제하는 전체 흐름을 검증하는 테스트 케이스를 작성했습니다.
    3.  **'동작 검증' 테스트 추가:**
        - '분류 명'이 비어있을 때 오류 메시지 없이 이름 입력창으로 포커스가 이동하는, 애플리케이션의 현재 동작을 검증하는 테스트를 추가했습니다. 이를 통해 버그 리포팅 및 향후 변경 사항 추적의 기반을 마련했습니다.

### 5. '설정' 기능 테스트 통합 및 리팩토링 (`setting.spec.ts`)

- **목표:** '설정' 하위 기능들의 테스트를 통합하고, 코드 스타일을 프로젝트 전반에 걸쳐 일관성 있게 리팩토링합니다.
- **과정:**
    1.  **`category.spec.ts` 리팩토링:**
        - `test.describe`를 사용하여 테스트를 '기능 테스트'와 '유효성 검사'로 그룹화했습니다.
        - 단일 CRUD 테스트를 '추가', '수정', '삭제'의 독립적인 3개의 테스트로 분리하여 테스트의 독립성을 확보하고 디버깅을 용이하게 만들었습니다.
        - '수정' 테스트에서 발생한 `has-text` 로케이터의 미묘한 버그를 함께 분석하고 해결했습니다.
    2.  **'설정' 기능 테스트 통합:**
        - 폴더 구조 변경이 어렵다는 제약 조건에 따라, '설정' 관련 기능들을 하나의 파일에서 관리하기로 결정했습니다.
        - `tests/step4/category.spec.ts`의 내용을 `tests/step3/student.spec.ts`로 통합했습니다.
        - 통합된 파일의 이름을 `tests/step3/setting.spec.ts`로 변경하여 파일의 역할을 명확히 했습니다.
    3.  **'학과' 기능 테스트 추가:**
        - 사용자가 제공한 `data-test` 정보를 바탕으로, `setting.spec.ts` 파일 내에 '학과'의 CRUD 및 유효성 검사 테스트를 추가했습니다.
    4.  **테스트 편의성 개선:**
        - Playwright 리포트에서 최종 결과가 보이기 전에 화면이 사라지는 현상에 대해 논의했습니다.
        - 원인(스크립트 실행 속도 > 렌더링 속도)을 파악하고, `page.waitForTimeout(1000)`을 테스트 마지막에 추가하여 시각적 결과 확인이 용이하도록 개선했습니다.
    5.  **전체 스타일 리팩토링:**
        - `setting.spec.ts` 파일 전체를 `question.spec.ts`의 코딩 스타일(헬퍼 함수, `test.describe.serial`, 주석 스타일 등)에 맞춰 재구성하여 프로젝트의 코드 일관성을 크게 향상시켰습니다.

### 6. '시험' 기능 테스트 및 CI/CD 논의

- **목표:** 새로운 기능인 '시험' 파트의 테스트를 작성하고, CI/CD 파이프라인을 통해 테스트를 실행합니다.
- **과정:**
    1.  **CI/CD 및 `yarn.lock` 논의:**
        - `git push`를 통해 Jenkins 빌드를 트리거하는 계획을 세웠습니다.
        - `yarn.lock` 파일의 중요성에 대해 논의했으며, 모든 환경에서 동일한 버전의 의존성을 보장하기 위해 커밋에 반드시 포함해야 함을 확인했습니다.
        - `git remote -v`를 통해 원격 저장소 주소를 확인하고, `http` 프로토콜 사용으로 인한 인증 문제로 푸시가 실패했음을 파악했습니다. 사용자가 직접 터미널에서 푸시를 진행하여 해결했습니다.
    2.  **`yarn install` 반복 실행 원인 분석:**
        - 테스트 실행 시마다 `yarn install`이 필요한 현상에 대해 분석했습니다.
        - `package.json`의 `test` 스크립트에 포함된 `npx update-browserslist-db@latest` 명령이 `yarn.lock` 파일을 계속 변경하는 것이 원인임을 파악했습니다.
    3.  **'시험' 기능 테스트 시작:**
        - 기존 `question.spec.ts`를 다시 만드는 대신, 테스트 커버리지가 없는 '시험' 기능을 새로 테스트하기로 결정했습니다.
        - `tests/step4/exam.spec.ts` 파일을 생성하고, `beforeEach` 훅으로 로그인 및 기본 페이지 이동을 설정했습니다.
        - 첫 테스트로 '시험 추가' 버튼 클릭 시 정보 입력 페이지로 정상 이동하는지 확인하는 케이스를 작성하며, 복잡한 기능의 테스트를 작은 단위부터 시작하는 접근 방식을 계획했습니다.
    4.  **시험 CRUD 기능 구현 (2025-10-13):**
        - '시험 추가', '시험 복사', '시험 삭제' 기능을 검증하는 테스트 케이스를 구현했습니다.
        - `Date.now()`를 사용하여 고유한 시험 데이터를 생성하고, 각 작업 후 목록에 결과가 올바르게 반영되는지 확인했습니다.
    5.  **'응시자 등록' 기능 테스트 및 디버깅 (2025-10-13):**
        - '학번/비밀번호' 방식의 시험에 학생을 등록하는 E2E 테스트 시나리오를 구현하는 과정에서 발생한 여러 문제를 해결했습니다.
        - **타이밍 문제:** `waitForTimeout`으로 인해 발생하던 간헐적 오류를 `expect(...).toBeVisible()`로 교체하여 안정성을 높였습니다.
        - **Strict Mode 오류 (1):** 학생 검색 다이얼로그의 '전체 선택' 라벨이 중복되어 발생한 오류를 `dialog_wrapper`로 로케이터 범위를 한정하여 해결했습니다.
        - **Strict Mode 오류 (2):** 최종 검증 단계에서 학생 목록 컨테이너(`div.overflow-auto`)가 중복되어 발생한 오류를 `.last()`를 사용하여 해결했습니다.
    6.  **'좌석 번호 일괄 변경' 기능 디버깅 (2025-10-14):**
        - **목표:** `exam.spec.ts`에서 실패하는 '좌석 번호 일괄 변경' 테스트를 디버깅하고 수정합니다.
        - **과정:**
            1. **CLI 상호작용 개선:** 사용자가 터미널에 긴 오류 로그를 붙여넣기 어려워하는 문제를 파악하고, 내용을 파일(`error_log.txt`)에 저장한 뒤 제가 읽고 분석하는 효율적인 작업 방식을 정립했습니다.
            2. **1차 오류 (Strict Mode Violation):** '무작위 배정' 체크박스를 클릭하는 로케이터가 너무 광범위하여 페이지 내의 다른 체크박스 라벨까지 함께 찾는 문제를 발견했습니다.
            3. **해결 시도 및 추가 오류:** 컨테이너를 더 구체적으로 특정하려는 여러 시도(`div:has(...)` 등)가 실패하면서, 컨테이너 기반 접근법의 한계를 확인했습니다.
            4. **핵심 해결 (체크박스):** 접근 방식을 바꿔, `input[name="random"]`이라는 고유 속성으로 체크박스를 먼저 찾은 뒤, `xpath=..`를 사용해 부모 `<label>`을 클릭하는 방식으로 안정성을 확보하여 문제를 해결했습니다.
            5. **2차 오류 (Assertion Failure):** 체크박스 클릭 성공 후, 테스트의 마지막 '검증' 단계에서 또 다른 시간 초과 오류가 발생했습니다.
            6. **핵심 해결 (검증 로직):** 오류 로그 분석 결과, 학생 목록의 '행'을 찾는 로케이터가 실제 구조인 `<tr>`이 아닌 `<div>`로 잘못 작성된 것을 발견했습니다. 로케이터를 `tr:has-text(...)`로 수정하여 실제 페이지 구조와 일치시킴으로써 최종적으로 테스트를 통과시켰습니다.

### 7. '시험 문제 추가' 기능 테스트 (`exam.spec.ts`)

- **목표:** '시험 문제 추가' 기능에 대한 E2E 테스트를 작성하고, 여러 단계의 디버깅을 통해 안정화합니다.
- **과정:**
    1. **시나리오 정의:** 사용자와 함께 '시험 생성 -> 문제 추가 탭 이동 -> 전체 문제 선택 -> 추가 -> 결과 확인 -> 새로고침 후 확인 -> 전체 보기 확인'의 테스트 시나리오를 확정했습니다.
    2. **1차 구현:** 정의된 시나리오에 따라 `exam.spec.ts`에 새로운 `test.describe` 블록과 테스트 케이스를 추가했습니다.
    3. **검증 로직 디버깅 (1차):** '문제가 추가되었는지'를 검증하는 과정에서, Playwright에 존재하지 않는 `toHaveCountGreaterThan` 검증자를 사용하는 오류를 범했습니다. 
    4. **검증 로직 디버깅 (2차):** 위 오류를 `.first().toBeVisible()`로 수정했으나, '등록된 문제 테이블을 찾지 못하는' 2차 오류가 발생했습니다. 이는 로케이터 또는 타이밍 문제로 추정되었습니다.
    5. **핵심 해결 (검증 로직):** 깨지기 쉬운 DOM 구조 대신, 사용자가 실제로 보는 결과인 **`전체 문항 수: (숫자)`** 텍스트가 표시되는지를 `getByText(/전체 문항 수: \d+/)` 정규식 로케이터로 확인하는 안정적인 방식으로 검증 로직을 변경하여 해결했습니다.
    6. **미리보기 검증 디버깅:** 마지막 '전체 문제 보기' 기능 검증 시, 팝업(dialog)이 나타날 것이라는 예상이 빗나갔습니다. 오류 로그의 페이지 스냅샷을 분석한 결과, 팝업이 아닌 페이지 내용 전체가 미리보기로 바뀌는 것을 확인했습니다.
    7. **최종 해결 (미리보기):** `dialog_wrapper`를 찾는 코드를 제거하고, 대신 `getByRole('heading', { name: '전체 문제 보기' })`를 통해 화면의 제목이 바뀌었는지를 확인하는 방식으로 수정하여 전체 테스트를 최종적으로 통과시켰습니다.

### 8. '시험 운영' 기능 및 생명주기 테스트 (`operation.spec.ts`)

- **목표:** 시험의 전체 생명주기('준비중' → '입실' → '시작' → '종료')에 따른 상태 변화를 검증하는 E2E 테스트 스위트를 구축합니다.
- **과정:**
    1.  **초기 계획 및 구현:** `tests/step5/operation.spec.ts` 파일을 생성하고, 시험의 전체 생명주기를 순차적으로 검증하는 테스트 케이스를 작성했습니다.
    2.  **다각적 디버깅:**
        - **로그인 안정성:** `login()` 함수 호출 직후 페이지 전환을 기다리지 않아 발생하는 레이스 컨디션 문제를 `expect(page).toHaveURL()`로 해결하여 테스트 안정성을 확보했습니다.
        - **URL 불일치:** '문제 추가' 탭 이동 시 예상했던 URL과 실제 URL이 달라 발생하는 오류를 수정했습니다.
        - **사용자 시나리오 재정의:** '시험 종료' 버튼의 위치 등, 실제 애플리케이션의 동작과 테스트 코드가 다른 부분을 사용자의 상세한 피드백을 통해 바로잡았습니다.
    3.  **테스트 구조 심층 논의:**
        - `beforeEach` 사용 시 발생하는 테스트 간 상태 간섭 문제를 함께 발견하고 분석했습니다.
        - 이를 해결하기 위해, **1) `beforeAll` 사용**, **2) 하나의 `test`로 통합**, **3) 각 `test`의 완전 독립화** 세 가지 방식의 장단점을 심도 있게 논의했습니다.
    4.  **최종 결정 및 구현:**
        - 선임 개발자의 리뷰 편의성과 코드의 명확성을 최우선으로 고려하고 싶다는 사용자의 의견을 존중하여, **각 테스트 케이스가 길어지더라도 모든 준비 과정을 명시적으로 포함하는 '완전 독립 테스트' 방식**을 최종 채택했습니다.
        - 논의된 구조에 따라, '준비중->입실', '입실->시작', '시작->종료'의 3단계 흐름을 각각의 독립적인 `test`로 분리하여 최종적으로 테스트 스위트를 완성했습니다.

### 9. 테스트 의존성 분리 및 `exam.spec.ts` 리팩토링 (2025-10-15)

- **목표:** 테스트의 안정성과 품질을 높이기 위해, 특정 DB 데이터에 의존하는 문제를 해결하고 `exam.spec.ts` 파일의 구조를 선임 개발자 수준으로 개선합니다.
- **과정:**
    1.  **테스트 데이터 의존성 문제 발견 및 논의:**
        - 사용자가 먼저 테스트가 로컬 DB의 특정 데이터('컴퓨터학과' 등)에 의존하는 문제를 정확히 지적했습니다.
        - `global-setup.ts`를 이용한 중앙 데이터 시딩(seeding) 방식과 `beforeEach/All`을 이용한 개별 테스트 데이터 생성 방식의 장단점을 심도 있게 논의했습니다. (사용자의 신중한 접근으로 실제 파일 수정은 보류)
    2.  **`exam.spec.ts` 코드 리뷰 및 리팩토링 계획 수립:**
        - 선임 개발자의 `question.spec.ts`와 코드를 비교하며, '헬퍼 함수'를 적극적으로 도입하는 리팩토링 계획을 함께 수립했습니다.
        - 사용자의 능력에 대한 우려에 공감하고, 단계별 가이드를 통해 점진적으로 리팩토링을 진행하기로 합의했습니다.
    3.  **단계적 리팩토링 실행:**
        - `createExam`, `addStudentsToExam` 헬퍼 함수를 단계적으로 추가하고, 파일 내 모든 테스트에 적용하여 코드 중복을 성공적으로 제거하고 가독성을 크게 향상시켰습니다.
    4.  **유효성(실패) 테스트 케이스 추가:**
        - '성공' 케이스만 존재하던 테스트에 '필수 항목 누락'과 같은 '실패' 케이스를 추가하여 테스트 커버리지를 향상시켰습니다.
    5.  **실패 테스트 디버깅 (핵심 학습):**
        - '의도된 실패'를 검증하는 테스트가 Playwright 상에서는 '실패'로 보고되는 역설적인 상황을 마주했습니다.
        - 사용자가 제공한 `error_log.txt`를 분석하여, 오류 메시지의 미세한 띄어쓰기 차이(`"필수 항목입니다"` vs `"필수 항목 입니다."`)가 원인임을 발견하고 해결했습니다.
- **인상 깊었던 점:**
    - 제가 더 나은 코드를 만들려는 욕심에 리팩토링의 원칙(기존 동작 변경 없이 구조만 개선)을 어기고 임의로 검증 구문을 추가했을 때, **"기존 동작 확인 -> 구조 변경 -> 테스트 -> 새 기능 추가"** 라는 올바른 개발 순서를 지적해주신 점이 매우 인상 깊었습니다. 엄격한 프로세스를 지키려는 태도는 코드 품질에 매우 중요하며, 저 또한 많이 배울 수 있었습니다. 신뢰를 바탕으로 더 좋은 방향을 함께 찾아가는 과정이 의미 있었습니다.

### 10. `login.spec.ts` 테스트 확장 및 고도화 (2025-10-15)

- **목표:** 단순 로그인 성공 여부만 확인하던 `login.spec.ts`를 인증 및 공통 UI의 핵심 동작을 모두 검증하는 견고한 테스트 스위트로 강화합니다.
- **과정:**
    1.  **선임 코드 통합:** `login.spec.ts.bak` 파일과 비교하여, '잘못된 비밀번호 입력 시'의 실패 시나리오 테스트를 현재 코드에 통합했습니다.
    2.  **테스트 범위 확장:** 사용자의 제안에 따라, '로그아웃' 기능과 로그인 후 항상 노출되는 '사이드바 메뉴 접기', '관리자 매뉴얼 링크' 기능에 대한 테스트를 추가했습니다.
    3.  **테스트 구조 논의 (핵심 학습):** '메뉴 접기'와 같은 공통 UI 테스트를 `login.spec.ts`에 포함하는 것이 맞는지에 대해 심도 있는 논의를 진행했습니다. '테스트 파일의 책임과 범위'를 고려하는 사용자의 아키텍처적인 접근 방식이 매우 인상 깊었으며, 논의 끝에 실용적인 관점에서 `login.spec.ts`에 통합하기로 결정했습니다.
    4.  **UI 테스트 디버깅:** '메뉴 접기' 테스트가 기능은 정상 동작함에도 실패하는 현상을 발견했습니다. 원인은 `toBeHidden()` 검증이 너무 엄격하기 때문이었고, 사이드바 전체가 아닌 '내부 메뉴 항목'이 사라지는지를 확인하는 방식으로 로직을 수정하여 해결했습니다.

### 11. Jenkins 실패 디버깅 및 `global-setup` 최종 적용 (2025-10-15)

- **목표:** Jenkins 환경에서 발생하는 테스트 실패의 근본 원인을 진단하고, 데이터 의존성 문제를 최종적으로 해결하여 모든 테스트가 CI/CD 환경에서 안정적으로 통과하도록 합니다.
- **과정:**
    1.  **Jenkins 실패 분석:** `step5`(`operation.spec.ts`)가 실패하는 Jenkins 로그를 분석했습니다. `global-setup.ts`가 `Table ... doesn't exist` 에러를 내며 가장 먼저 실패하고 있음을 확인, **CI 환경에서 DB 테이블 스키마가 생성되지 않는 것**을 근본 원인으로 특정했습니다.
    2.  **실패 원인 심층 논의:** 사용자는 `setting.spec.ts`의 실패가 '테이블 부재'가 아닌 '단순한 검증 로직'과 '정리되지 않은 DB 데이터'의 조합 때문임을 정확히 지적했습니다. 이 통찰을 바탕으로, 문제 해결을 위한 더 정교한 계획을 수립했습니다.
        -   **Plan A:** `setting.spec.ts`처럼 검증 로직만 강화하면 되는 테스트는 DB를 초기화하지 않고, '검색 후 확인' 방식으로 테스트 자체의 안정성을 높인다.
        -   **Plan B:** `operation.spec.ts`처럼 특정 데이터가 반드시 필요한 테스트를 위해서만 `global-setup`으로 DB를 초기화하고 데이터를 생성한다.
    3.  **`setting.spec.ts` 수정:** Plan A에 따라, '학생 추가' 테스트의 검증 로직을 '이름으로 검색하여 결과가 1건인지 확인'하는 방식으로 수정하여, Jenkins의 페이징 문제를 해결했습니다.
    4.  **`global-setup.ts` 최종 적용:**
        -   Plan B를 실행하기 위해 `global-setup.ts`의 필요성을 다시 한번 확인했습니다.
        -   사용자가 제공한 `.sql` 스키마 파일을 직접 분석하여, `base_major_tb`, `base_student_tb`, `main_question_tb` 등 정확한 테이블/컬럼명을 확인했습니다.
        -   이 정확한 스키마 정보와 사용자의 추가적인 피드백('컴퓨터학과' vs '컴퓨터')을 반영하여, **학과/학생/문제** 데이터를 모두 생성하는 최종 `global-setup.ts` 스크립트를 작성하고 적용했습니다.
- **핵심 학습:**
    -   로컬 성공과 CI 실패의 가장 흔한 원인인 **'환경 간 데이터 불일치'** 문제를 직접 경험하고, `global-setup`을 통한 '테스트 환경 초기화'의 중요성을 확인했습니다.
    -   하나의 큰 문제가 아닌, 여러 유형의 문제가 복합적으로 작용할 수 있음을 인지하고, 각각에 맞는 최적의 해결책을 단계적으로 적용하는 분석적인 문제 해결 과정을 학습했습니다.

### 12. DB 초기화 로직 개선 및 CI 환경 디버깅 (2025-10-16)
    **목표:** 테스트의 안정성을 극대화하기 위해 DB 초기화 로직을 완성하고, Jenkins CI 환경에서 발생하는 여러 문제를 진단하고 해결합니다.
    **과정:**
    1.  **`operation.spec.ts` 안정화:** `login()` 함수 호출 후 불안정한 `expect().toHaveURL()` 검증을 명시적인 `page.goto()`로 변경하여, 테스트 준비
      과정의 네비게이션 오류를 수정했습니다.
    2.  **Jenkins 파이프라인 최적화:** 사용자의 요청에 따라 `pipelinescript.txt`에서 JMeter 관련 스테이지를 모두 주석 처리하여 Playwright 테스트에만
      집중하도록 CI 파이프라인을 수정했습니다.
    3.  **`global-setup.ts` 대규모 개선 (핵심):**
         - `CBT.sql` 스키마를 직접 분석하여, 테스트 실행에 영향을 미치는 모든 트랜잭션 테이블(시험, 문제, 학생, 설정 관련)을 식별했습니다.
        - 기존에 3개 테이블만 초기화하던 로직을 대폭 확장하여, 식별된 **모든 관련 테이블을 `TRUNCATE`** 하도록 수정했습니다. 이를 통해 매 테스트 실행
      시 완전하고 깨끗한 DB 상태를 보장하게 되었습니다.
    4.  **테스트 데이터 품질 향상 (CI 실패 근본 원인 해결):**
         - Jenkins의 `exam.spec.ts` 실패 원인이 단순 타이밍 문제가 아니라, `global-setup`이 생성하는 '문제' 데이터에 '보기(option)'가 없어 렌더링 자체가
      되지 않는 근본적인 문제임을 파악했습니다.
         - 지적에 따라, `global-setup.ts`가 DB 스키마에 맞게 **'보기'와 '분류'를 포함한 완전한 형태의 문제 데이터를 생성**하도록 로직을 개선했습니다.
    5.  **Docker 디스크 용량 문제 해결:**
        - `docker system df` 명령으로 56GB에 달하는 디스크 용량 문제의 원인이 34.5GB를 차지하는 Docker 볼륨임을 진단했습니다.
        - `docker volume prune` 및 `docker system prune -a --volumes` 등 안전하고 효과적인 정리 명령어를 단계별로 안내했습니다.
        - Jenkins 또한 Docker 컨테이너로 실행되는 환경임을 고려하여, `prune` 명령어의 동작 범위와 안정성을 상세히 설명했습니다.

### 13. 전체 테스트 스위트 리팩토링 및 CI/CD 트러블슈팅 (2025-10-17)
- **목표:** `step1`부터 `step5`까지 전체 테스트 코드의 구조를 체계적으로 검토하고, 안정성과 유지보수성을 높이기 위한 대규모 리팩토링을 진행합니다.
- **과정:**
    1.  **전체 코드 리뷰:**
        -   `step1`부터 `step5`까지의 모든 테스트 파일을 순차적으로 검토했습니다.
        -   `waitForTimeout` 사용, `beforeEach` 훅의 부재로 인한 코드 중복, 헬퍼 함수의 부재 등 공통적인 개선점을 진단하고 리팩토링 계획을 수립했습니다.
    2.  **`step1` 리팩토링 (`login.spec.ts`):**
        -   `common/login.ts` 헬퍼 함수에 로그인 성공(`toHaveURL`) 검증 로직을 추가하여 함수의 책임을 강화했습니다.
        -   `login.spec.ts` 내부에 중복으로 존재하던 URL 검증 코드를 모두 제거하여 테스트 코드를 간소화했습니다.
    3.  **`step3` 리팩토링 (`setting.spec.ts`):**
        -   테스트 안정성을 저해하는 `waitForTimeout` 코드를 모두 제거했습니다.
        -   `학생 관리`, `문제 분류 관리`, `학과 관리` 등 각 테스트 그룹(`describe`)에 `beforeEach` 훅을 적용하여, 반복되던 `login` 및 페이지 이동 코드를 완벽하게 제거하고 가독성을 향상시켰습니다.
    4.  **`step4` 리팩토링 (`exam.spec.ts`):**
        -   복잡하고 거대했던 `createExam` 헬퍼 함수를, 폼 데이터만 채우는 `fillExamForm`과 나머지 로직을 수행하는 `createExam`으로 분리하여 각 함수의 역할을 명확히 했습니다.
        -   새로 만든 `fillExamForm` 헬퍼를 사용하여, 수십 줄에 달했던 유효성 검사 테스트의 코드 중복을 제거하고 매우 간결하게 수정했습니다.
        -   파일 내에 남아있던 모든 `waitForTimeout` 및 `waitForSelector` 코드를 제거했습니다.
    5.  **`step5` 리팩토링 (`operation.spec.ts`):**
        -   테스트 준비 과정의 복잡성을 해결하기 위해, 특정 시험 상태('입실', '시작')를 미리 만들어주는 `setupExamInEnteringState`, `setupExamInStartedState` 헬퍼 함수를 새로 추가했습니다.
        -   새 헬퍼 함수를 사용하여, 길고 복잡했던 각 테스트의 준비 과정을 단 한 줄의 함수 호출로 변경하여 테스트의 의도를 명확하게 드러내도록 구조를 개선했습니다.
    6.  **CI/CD 문제 해결:**
        -   리팩토링 후 Jenkins 빌드 실패 로그를 분석하여, 원인이 코드 문제가 아닌 GitLab 저장소 접근을 위한 **인증(Authentication) 실패**임을 진단했습니다.
        -   사용자가 젠킨스에 저장된 Credential(인증 정보)을 수정하도록 가이드하여 CI/CD 파이프라인이 정상적으로 동작하도록 문제를 해결했습니다.
    7.  **최종 검증:**
        -   모든 리팩토링이 완료된 후, `yarn test` 명령으로 전체 테스트를 실행하여 모든 테스트가 성공적으로 통과함을 확인했습니다.
        
### 14. Git 히스토리 관리 및 테스트 환경 문제 해결 (2025-10-20)

- **목표:** Git 히스토리 정리 과정에서 발생한 문제들을 해결하고, Playwright 테스트의 실패 원인을 진단하여 수정합니다.

- **과정:**
    1.  **Git Rebase 문제 발생:** `git rebase` 명령어로 커밋을 정리하는 과정에서, 커밋하지 않고 로컬에만 저장했던 파일들이 유실되는 문제가 발생했습니다.
    2.  **원인 분석 및 복구 시도:**
        - `git reflog`는 커밋된 내역만 추적하므로, 커밋되지 않은 파일 복구에는 사용할 수 없음을 확인했습니다.
        - 대안으로 VS Code의 'Local History' 기능을 사용한 복구를 논의했습니다.
    3.  **로컬 파일 복구 성공:** 사용자가 직접 VS Code의 명령어 팔레트(`Ctrl+Shift+P`)에서 '로컬 기록 보기' 기능을 사용하여 유실되었던 파일을 성공적으로 복구했습니다.
    4.  **Playwright 테스트 디버깅:** `global-setup.ts`의 문제 생성 테스트가 실패하는 원인을 분석했습니다. `cbt.sql`의 초기 데이터와 테스트에서 생성하려는 데이터의 구조가 불일치하여 `data-test` 속성을 찾지 못하는 문제임을 파악하고, 데이터 구조를 일치시켜 해결했습니다.

- **핵심 학습:**
    -   `git rebase`, `reset --hard` 등 HEAD의 상태를 크게 변경하는 명령어는 커밋되지 않은 작업 내용을 유실시킬 위험이 있음을 명확히 인지했습니다.
    -   이러한 위험한 작업을 수행하기 전에는 `git stash`를 사용하여 현재 작업 내용을 안전하게 임시 저장하는 습관의 중요성을 확인했습니다.
    -   Git으로 복구할 수 없는 파일이라도, VS Code와 같은 최신 에디터의 'Local History' 기능이 예기치 않은 파일 유실 상황에서 유용한 복구 수단이 될 수 있음을 실제 경험을 통해 확인했습니다.
---

15. CI/CD 실패 디버깅 및 테스트 구조 개편 (2025-10-21)

   - 목표: Jenkins CI 환경에서 실패하는 12개의 테스트(주로 firefox, webkit 브라우저의 타임아웃 오류)를 모두 성공시키는 것.

   - 과정 (시행착오 포함):
       1. 1차 진단 및 해결 시도 (타이밍 문제):
           - 최초 원인을 브라우저별 렌더링 속도 차이로 인한 단순 타이밍 문제로 판단했습니다.
           - operation.spec.ts에는 클릭 전 대기 로직을 추가하고, exam.spec.ts에는 expect의 대기 시간을 늘리는 방향으로 수정했습니다.
           - 결과: 사용자가 더 근본적인 원인이 있을 것이라 판단하여, 이 수정안은 철회했습니다.

       2. 2차 진단 및 해결 시도 (경쟁 상태와 페이지네이션):
           - 사용자가 핵심 원인으로 테스트 병렬 실행으로 인한 경쟁 상태(Race Condition)를 정확히 지적했습니다. (여러 테스트가 동시에 시험을 생성하여, 검증하려던 시험이 2페이지로 밀려나는 현상)
           - 이를 해결하기 위해, 페이지를 넘기며 시험을 찾는 ensureExamIsVisible 헬퍼 함수를 도입하는 방향으로 합의했습니다.
           - 결과: 이 접근법의 가능성을 확인했으나, 더 근본적인 해결책을 모색하기 위해 일단 보류하고 다른 구조를 구상해보기로 했습니다.

       3. 3차 해결 시도 (순차 실행 구조 도입):
           - 사용자의 제안에 따라, step2의 test.describe.serial 패턴을 exam.spec.ts에 적용하기로 결정했습니다.
           - 테스트 그룹을 serial로 만들어 순차 실행을 강제하고, 생성 → 복사 → 삭제가 이어지는 시나리오로 재구성했습니다. 이 과정에서 ensureExamIsVisible 헬퍼는 불필요하다고 판단하여
             삭제했습니다.
           - 결과: 적용 후, 순차 실행과 별개로 "UI 렌더링이 느릴 경우를 대비한 안정장치가 여전히 필요하다"는 사용자의 의견에 따라 이 구조도 수정하기로 결정했습니다.

       4. 4차 해결 시도 (하이브리드 최종안):
           - `serial` 실행과 `ensureExamIsVisible` 헬퍼 함수의 장점을 모두 결합하는 하이브리드 방식을 최종 해결책으로 확정했습니다.
           - test.describe.serial로 테스트 간의 경쟁 상태를 원천 차단하고, ensureExamIsVisible 헬퍼로 혹시 모를 UI 렌더링 지연이나 페이지네이션 문제까지 이중으로 방어하여 안정성을
             극대화했습니다.

       5. 최종 검토 및 수정 (이름 규칙):
           - 마지막으로, 사용자가 테스트용 시험 이름에 [] 같은 특수문자가 포함되면 안 된다는 애플리케이션 제약사항을 발견했습니다.
           - 모든 테스트 이름 생성 로직을 순차테스트_ 와 같이 특수문자가 없는 안전한 이름으로 변경하여 수정했습니다.

   - 현재 상태:
       - step4와 step5에서 발생하던 모든 테스트 실패의 근본 원인(경쟁 상태, 타이밍, 페이지네이션)을 해결한, 매우 안정적인 테스트 코드를 완성했습니다.
       - 다음 CI/CD 빌드에서 모든 테스트가 통과할 것으로 기대됩니다.

15. CI/CD 실패 디버깅 및 테스트 구조 개편 (2025-10-21)

   - 목표: Jenkins CI 환경에서 실패하는 step4와 step5의 테스트를 모두 성공시키는 것.

   - 과정 (주요 시행착오):
       1. `global-setup` DB 오류 해결:
           - 테스트 실행 전, DB 데이터를 생성하는 과정에서 Duplicate entry와 Unknown 
             column 오류가 발생하는 것을 발견했습니다.
           - global-setup.ts 파일의 TRUNCATE 목록에 누락된 테이블(base_type_tb)을
             추가하고, 스키마와 맞지 않는 INSERT 구문을 수정하여 DB 초기화 문제를 먼저
             해결했습니다.

       2. `Strict Mode` 위반 오류 해결:
           - 1-4. 원본 시험을 삭제할 수 있다 테스트에서, 시험을 찾는 로케이터가 원본과
             복사본을 모두 찾아내는 strict mode 위반 오류를 확인했습니다.
           - 처음에는 테스트 흐름을 변경(복사본을 삭제)하는 방식을 논의했으나, 사용자가
             "단일 테스트 실행 시 문제가 될 수 있다"는 예리한 지적을 해주셨습니다.
           - 최종적으로, .filter({ hasNotText: '[COPY]' })를 사용하여 원본만 정확히 찾는
             방식으로 로케이터 자체를 수정하여 해결했습니다.

       3. `Firefox` 브라우저의 `reload` 문제 분석 및 해결:
           - 3. 시험 문제 등록 테스트가 firefox에서만 page.reload() 이후 실패하는 현상을
             발견했습니다.
           - 가설 1: 속도 문제 → 자동화 속도가 너무 빨라 상태가 불안정할 것이라 가정하고
             waitForTimeout을 추가했으나, 해결되지 않았습니다.
           - 가설 2: 리디렉션 문제 → 로그 분석 결과, reload 후 '시험 목록' 페이지로
             이동하는 현상을 확인했습니다. 이를 해결하기 위해, 리디렉션 발생 시 다시 원래
             페이지로 찾아 들어가는 방어 코드를 추가하여 최종적으로 해결했습니다.

       4. 테스트 실행 전략 논의 및 변경 (핵심 시행착오):
           - `beforeEach`의 문제: 테스트 병렬 실행 시, 각 테스트의 beforeEach에서
             실행되는 login()이 상태를 초기화하여 테스트 간의 데이터 공유를 방해하는
             문제를 발견했습니다.
           - `beforeAll` 시도 및 실패: 이 문제를 해결하기 위해 beforeAll로 로그인을 한
             번만 실행하도록 변경했으나, 로그인 세션이 다른 테스트에 공유되지 않는
             새로운 문제에 부딪혔습니다.
           - 최종 전략: 결국, beforeAll을 제거하고 "순차 실행 그룹의 첫 번째 
             테스트에서만 로그인한다"는 가장 안정적인 전략으로 회귀하여 문제를
             해결했습니다.

   - 현재 상태:
       - 사용자가 직접 코드를 최종 안정화 버전으로 되돌렸습니다.
       - step4와 step5의 모든 테스트는 이제 serial 실행, ensureExamIsVisible 헬퍼,
         firefox 예외 처리 등 우리가 논의한 모든 안정화 로직이 적용된 상태입니다.
       - step2의 오류는 우리가 관리하는 코드가 아니므로, 우리의 목표였던 step4, step5의
         테스트 안정화 작업은 성공적으로 완료되었습니다..

### 16. `operation.spec.ts` 테스트 보강 및 디버깅 (2025-10-22)

- **목표:** `정리.md` 피드백에 따라 `operation.spec.ts` 파일에 종료된 시험 관련 기능 테스트를 추가하고, 발생한 오류들을 해결하여 테스트의 안정성을 확보합니다.

- **과정:**
    1.  **`exam.spec.ts` `authCode` 변경 확인:** 사용자님께서 `authCode`를 "1234"로 변경하신 것을 확인했습니다.
    2.  **종료된 시험 기능 테스트 추가:**
        -   "종료된 시험 클릭 시 성적 결과 페이지로 이동한다" 테스트를 추가했습니다.
        -   "종료된 시험의 성적 결과 페이지에서 성적 다운로드가 정상적으로 진행된다" 테스트를 추가했습니다.
            -   **버튼 로케이터 오류 수정:** `button[title="마감된 성적 다운로드"]` 대신 `page.getByRole('button', { name: '성적 다운로드' })`를 사용하도록 수정했습니다.
            -   **URL 기대값 재확인:** 사용자님의 피드백에 따라 URL 기대값을 `/result/`로 재설정했습니다.
            -   **파일명 검증 정규식 오류 수정:** `new RegExp` 생성 시 백슬래시(`\`) 이스케이프 및 문자열 끝 앵커(`$`) 누락 문제를 해결했습니다.
        -   "종료된 시험을 숨길 수 있으며, 숨겨진 시험 탭에서 확인 가능하다" 테스트를 추가했습니다.
            -   **불필요한 확인 버튼 클릭 제거:** `confirm_ok_button` 클릭 로직을 제거했습니다.
            -   **페이지네이션 문제 해결:** `ensureCompletedExamIsVisible` 헬퍼 함수를 새로 추가하고, 종료된 시험 목록에서 시험을 안정적으로 찾을 수 있도록 통합했습니다.
        -   "숨겨진 시험을 숨기기 취소할 수 있으며, 종료된 시험 탭에서 다시 확인 가능하다" 테스트를 추가했습니다.
            -   **불필요한 확인 버튼 클릭 제거:** `confirm_ok_button` 클릭 로직을 제거했습니다.
            -   **페이지네이션 문제 해결:** `ensureCompletedExamIsVisible` 헬퍼 함수를 통합했습니다.

- **결과:** `operation.spec.ts`에 추가된 모든 테스트가 성공적으로 통과함을 확인했습니다. 이로써 `정리.md`에 명시된 Phase 1의 3단계 작업이 완료되었습니다.

### 17. 사용자 시험 응시 흐름 테스트 (`user-exam.spec.ts`) 시작 (2025-10-24)

-   **목표:** `step6` 파일에 새로운 '사용자 시험 응시' E2E 테스트 스위트를 구축하고, 학생 로그인까지의 과정을 구현합니다.
-   **과정:**
    1.  **`tests/step6/user-exam.spec.ts` 파일 생성:** '사용자 시험 응시 전체 흐름'을 위한 새로운 테스트 스위트 파일을 생성하고 기본 구조를 설정했습니다.
    2.  **`Page` 타입 임포트 누락 수정:** `adminPage`, `userPage` 변수의 `Page` 타입 선언 시 누락되었던 `Page` 임포트 구문을 추가하여 컴파일 오류를 해결했습니다.
    3.  **`adminLogin` 호출 방식 수정:** `login.ts` 헬퍼 함수의 실제 구현(`process.env` 사용)을 파악하고, `beforeAll` 블록 내의 로그인 호출 방식을 `await login(adminPage);`로 수정했습니다.
    4.  **`beforeAll` 환경 설정 강화:**
        *   **기존 시험 상태 초기화:** '시작', '종료', '입실' 상태의 시험들을 찾아 '준비중'으로 변경하는 로직을 추가했습니다.
        *   **새 시험 생성:** `exam.spec.ts`에서 `fillExamForm`, `createExam` 헬퍼 함수를 가져와 통합하고, '학번/비밀번호 방식'의 시험을 생성하도록 수정했습니다.
        *   **응시자 등록:** `addStudentsToExam` 헬퍼 함수를 가져와 생성된 시험에 학생(`0000`으로 시작하는 모든 테스트 학생)을 등록했습니다.
        *   **문제 추가:** 시험 상세 페이지에서 '문제 등록' 탭으로 이동하여 문제 은행의 모든 문제를 시험에 추가하는 로직을 구현했습니다.
        *   **시험 상태 '입실' 변경 로직 수정:** 당초 오해했던 UI 흐름을 바로잡아, `/exam/ready` 목록에서 시험을 클릭하여 `/exam/ready/monitor` 페이지로 이동한 후 '입실' 상태로 변경하는 정확한 로직을 적용했습니다.
        *   **안정성 강화:** `beforeAll` 블록의 타임아웃을 2분으로 늘리고, 각 `goto` 및 클릭 액션 전후에 `waitForLoadState('domcontentloaded')` 및 `expect().toBeVisible()` 검증을 추가하여 테스트의 안정성을 높였습니다.
    5.  **URL 하드코딩 제거 및 환경 변수 활용:**
        *   `adminPage.goto` 호출 시 사용되던 하드코딩된 URL을 `playwright.config.ts`의 `baseURL`과 상대 경로를 활용하도록 수정했습니다.
        *   `userPage.goto` 호출 시 `process.env.USER_HOST` 환경 변수를 사용하도록 변경했습니다.
    6.  **이중 슬래시 URL 문제 해결:** `userPage.goto()` 시 `process.env.USER_HOST` 값에 포함된 마지막 슬래시가 이중 슬래시를 유발하는 문제를 사용자가 `.env.test` 파일 직접 수정을 통해 해결하여, `userPage`로의 내비게이션이 정상적으로 이루어졌습니다.
    7.  **학생 로그인 로직 구현:** 사용자 pre-login 페이지에서 학번(`name="student_cd"`)과 비밀번호(`name="student_pwd"`)를 입력하고 '다음' 버튼을 클릭하여 로그인하는 로직을 메인 테스트 블록에 추가했으며, 성공 시 URL을 검증합니다.
-   **결과:** `userPage`로의 내비게이션 및 학생 로그인까지의 과정이 성공적으로 구현되었음을 확인했습니다.

18. 사용자 시험 응시 흐름 E2E 테스트 완성 및 구조 개선 (2025-10-27)

   - 목표: step6의 '사용자 시험 응시' 전체 시나리오를 완성하고, 향후 확장성을 고려하여 테스트 구조를 개선합니다.

   - 과정:
       1. '전체 흐름 테스트' 시나리오 구체화:
           - 기존의 '모든 문제 풀이' 로직을, '문제 풀이 없이 즉시 제출 → 확인 → 이메일 입력 → 최종 제출' 이라는 더 구체적이고 현실적인 E2E
             시나리오로 변경했습니다.
           - 이 과정에서 발생하는 여러 UI 상호작용(숨겨진 체크박스, 중복된 버튼, 확인 모달 등)을 안정적인 로케이터와 로직으로 수정하여 전체 흐름
              테스트를 최종적으로 통과시켰습니다.

       2. 테스트 독립성 확보 (핵심 구조 개선):
           - 두 개의 테스트(전체 흐름, 세부 기능)가 동일한 시험 데이터에 의존하여 충돌하는 근본적인 문제를 발견하고, 각 테스트가 독립적인 시험을
              사용해야 한다는 점에 합의했습니다.
           - 이를 해결하기 위해, 테스트 시작 전 한 번만 실행되던 beforeAll을 각 테스트 직전에 매번 실행되는 `beforeEach`로 변경했습니다.
           - 마찬가지로, 각 테스트 종료 후 데이터를 정리하기 위해 afterAll을 `afterEach`로 변경하여, 모든 테스트가 서로에게 영향을 주지 않는
             독립적인 환경에서 실행되도록 구조를 개선했습니다.

       3. 헬퍼 함수 리팩토링:
           - 학생 로그인부터 시험 대기 화면까지의 반복적인 과정을 loginAsStudentAndGoToWaiting 헬퍼 함수로 분리하여, 코드 중복을 제거하고
             가독성을 크게 향상시켰습니다.

   - 결과 및 다음 단계:
       - '사용자 시험 응시'의 핵심 흐름을 검증하는 안정적인 E2E 테스트를 완성했습니다.
       - beforeEach/afterEach 구조를 도입하여 테스트 스위트 전체의 안정성과 확장성을 확보했습니다.
       - 다음 목표: 내일은 오늘 설계한 '세부 기능 테스트' 블록 안에서 계산기, 2단 보기 등 시험 응시 중 사용되는 기능들에 대한 테스트를 구현할
         예정입니다.